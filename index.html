<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Diff Viewer</title>

<style>
:root {
    --bg-main: #f5f0e6;
    --bg-panel: #ede4d3;
    --bg-diff: #f2d6d6;
    --border: #c9b99a;
    --text: #2b2b2b;
}

.line-active {
    background: #cdbf9f;
}

body {
    margin: 0;
    background: var(--bg-main);
    color: var(--text);
    font-family: Consolas, monospace;
	padding-top: 65px;
}

header {
    position: fixed;
    top: 0;
    z-index: 100;
    background: #e6dcc8;
    border-bottom: 1px solid var(--border);
    padding: 8px;
    display: flex;
    gap: 8px;
    align-items: center;
	height: 48px;
}

button {
    background: #d8cbb0;
    border: 1px solid var(--border);
    padding: 5px 10px;
    cursor: pointer;
}
button:hover { background: #cdbf9f; }

.container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    height: calc(100vh - 48px);
	padding-top: 0px;
}

.panel {
    display: flex;
    flex-direction: column;
    border-right: 1px solid var(--border);
}

textarea {
    height: 120px;
    resize: none;
    border: none;
    border-bottom: 1px solid var(--border);
    background: #faf6ef;
    padding: 8px;
    font-size: 13px;
}

.word-diff-remove {
    background-color: #f8a3a3;
    text-decoration: line-through;
    color: #a00;
}

.word-diff-add {
    background-color: #a3f8a3;
    color: #006400;
}

.removed { background-color: #ffeef0; }
.added { background-color: #e6ffed; }
.modified { background-color: #fff9e6; }

.diffview {
    flex: 1;
    overflow: auto;
    background: var(--bg-panel);
    display: grid;
    grid-template-columns: 60px 1fr;
}

.lineno {
    min-height: 1.2em; 
}

.code {
    padding: 4px 8px;
    white-space: pre-wrap;
    min-height: 1.2em; 
    line-height: 1.2em;
}


.kw { color: #005f87; font-weight: bold; }
.str { color: #8f3f71; }
.num { color: #af3a03; }
.com { color: #6a737d; font-style: italic; }
.tag { color: #005cc5; }


.diff { background: var(--bg-diff); }
.diff-active {
    outline: 2px solid #e67e22 !important; 
    outline-offset: -2px;
    background-color: rgba(230, 126, 34, 0.1) !important;
}

.word-diff { 
    padding: 0 1px; 
    border-radius: 2px; 
}


#leftView .word-diff { 
    background: #f8a3a3; 
    text-decoration: line-through;
}


#rightView .word-diff { 
    background: #a3f8a3; 
}
</style>
</head>

<body>

<header>
    <button onclick="compare()">Comparer</button>
    <button onclick="prevDiff()">â—€</button>
    <button onclick="nextDiff()">â–¶</button>
    <button onclick="resetLeft()">Reset G</button>
    <button onclick="resetRight()">Reset D</button>
    <button onclick="resetAll()">Reset All</button>
    <button onclick="toggleOnlyDiff()">Diff only</button>
	<script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js" data-name="bmc-button" data-slug="miw4n" data-color="#FFDD00" data-emoji="ðŸ§‹"  data-font="Cookie" data-text="Buy me a bubble tea" data-outline-color="#000000" data-font-color="#000000" data-coffee-color="#ffffff" ></script>    <span id="info"></span>
    <span id="info"></span>
</header>

<div class="container">
    <div class="panel">
        <textarea id="left" placeholder="Texte gauche"></textarea>
        <div id="leftView" class="diffview"></div>
    </div>
    <div class="panel">
        <textarea id="right" placeholder="Texte droite"></textarea>
        <div id="rightView" class="diffview"></div>
    </div>
</div>

<script>
let diffs = [];
let diffIndex = -1;

let ignoreSpaces = false;
let ignoreEmpty = false;
let onlyDiff = false;

function syncScroll(a, b) {
    let lock = false;
    a.addEventListener("scroll", () => {
        if (lock) return;
        lock = true;
        b.scrollTop = a.scrollTop;
        lock = false;
    });
}
syncScroll(document.getElementById("leftView"), document.getElementById("rightView"));
syncScroll(document.getElementById("rightView"), document.getElementById("leftView"));

function gotoLine(container, lineIndex) {
    container.querySelectorAll(".line-active")
        .forEach(l => l.classList.remove("line-active"));

    let codeLine = container.children[lineIndex * 2 + 1];
    let numLine  = container.children[lineIndex * 2];

    if (!codeLine) return;

    codeLine.classList.add("line-active");
    numLine.classList.add("line-active");

    codeLine.scrollIntoView({block:"center", behavior:"smooth"});
}

function myersDiff(a, b) {
    const N = a.length;
    const M = b.length;
    const max = N + M;
    const v = new Map();
    v.set(1, 0);
    const trace = [];

    for (let d = 0; d <= max; d++) {
        const current = new Map(v);
        trace.push(current);

        for (let k = -d; k <= d; k += 2) {
            let x;
            if (k === -d || (k !== d && v.get(k-1) < v.get(k+1))) x = v.get(k+1);
            else x = v.get(k-1)+1;
            let y = x - k;

            while (x<N && y<M && a[x]===b[y]) { x++; y++; }
            current.set(k, x);
            if (x>=N && y>=M) return buildEditScript(trace,a,b);
        }
        v.clear();
        for (let [k,val] of current) v.set(k,val);
    }
}

function buildEditScript(trace, a, b) {
    let x=a.length, y=b.length;
    const result = [];
    for (let d=trace.length-1; d>=0; d--) {
        const v = trace[d];
        const k = x-y;
        let prevK;
        if (k===-d || (k!==d && v.get(k-1)<v.get(k+1))) prevK = k+1;
        else prevK = k-1;

        const prevX = v.get(prevK);
        const prevY = prevX - prevK;

        while (x>prevX && y>prevY) { result.push({type:"equal", line:a[x-1]}); x--; y--; }
        if (d===0) break;
        if (x===prevX) { result.push({type:"add", line:b[y-1]}); y--; }
        else { result.push({type:"remove", line:a[x-1]}); x--; }
    }
    return result.reverse();
}

function preprocess(lines) {
    return lines.map(l => {
        let x = l;
        if (ignoreSpaces) x = x.trimEnd(); 
        return x;
    });
}

function detectLang(t) {
    if(/^\s*<[^>]+>/m.test(t)) return "html";
    if(/^\s*(router|interface|ip route|vrf)/mi.test(t)) return "cfg";
    if(/^\s*#include|int main|printf\(/m.test(t)) return "c";
    if(/^\s*def |import |print\(/m.test(t)) return "py";
    return "plain";
}

function highlight(t) {
    return t
        .replace(/(\/\/.*|#.*)/g, '<span class="com">$1</span>')
        .replace(/(&quot;.*?&quot;|&#039;.*?&#039;)/g, '<span class="str">$1</span>')
        .replace(/\b(\d+)\b/g, '<span class="num">$1</span>')
        .replace(/\b(int|if|else|for|while|return|def|import|function|router|interface|ip)\b/g, '<span class="kw">$1</span>')
        .replace(/(&lt;\/?\w+.*?&gt;)/g, '<span class="tag">$1</span>');
}

function wordDiff(textLeft, textRight) {
    const wordsL = textLeft.split(/(\s+)/);
    const wordsR = textRight.split(/(\s+)/);
    
    let outL = "";
    let outR = "";

    const setL = new Set(wordsL.filter(w => w.trim() !== ""));
    const setR = new Set(wordsR.filter(w => w.trim() !== ""));

    wordsL.forEach(word => {
        if (word.trim() !== "" && !setR.has(word)) {
            outL += `<span class="word-diff-remove">${word}</span>`;
        } else {
            outL += word;
        }
    });

   
    wordsR.forEach(word => {
        if (word.trim() !== "" && !setL.has(word)) {
            outR += `<span class="word-diff-add">${word}</span>`;
        } else {
            outR += word;
        }
    });

    return [outL, outR];
}

function escapeHTML(str) {
    return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

function renderLine(container, num, text, cls, otherText = "", isRight = false) {
    const ln = document.createElement("div");
    ln.className = "lineno";
    ln.textContent = num;

    const cd = document.createElement("div");
    cd.className = "code " + cls;

    let safeText = escapeHTML(text);
    let finalHTML = "";

    if (cls === "modified" && otherText !== "") {
        finalHTML = getDiffMarkup(safeText, escapeHTML(otherText), isRight);
    } else {
        finalHTML = highlight(safeText);
    }

    cd.innerHTML = finalHTML || "&nbsp;";
    if (cls !== "equal") cd.dataset.diff = "";
    
    container.appendChild(ln);
    container.appendChild(cd);
}

function getDiffMarkup(textToShow, textToCompare, isAddition) {
    const wordsShow = textToShow.split(/(\s+|\b)/);
    const wordsComp = textToCompare.split(/(\s+|\b)/);
    
    const setCompare = new Set(wordsComp.filter(w => w.trim() !== ""));
    
    let output = "";
    wordsShow.forEach(word => {
        const trimmed = word.trim();
        if (trimmed !== "" && !setCompare.has(trimmed)) {
            const spanClass = isAddition ? "word-diff-add" : "word-diff-remove";
            output += `<span class="${spanClass}">${word}</span>`;
        } else {
            output += word;
        }
    });
    return output;
}

function renderEmpty(container){
    const ln=document.createElement("div");
    ln.className="lineno"; ln.textContent="";
    const cd=document.createElement("div");
    cd.className="code";
    container.appendChild(ln); container.appendChild(cd);
}

function compare() {
    diffs = []; diffIndex = -1;
    const L = preprocess(left.value.split("\n"));
    const R = preprocess(right.value.split("\n"));
    const script = myersDiff(L, R);
    
    leftView.innerHTML = ""; rightView.innerHTML = "";
    let lnum = 1, rnum = 1;

    let i = 0;
    while (i < script.length) {
        let cur = script[i];

        if (cur.type === "equal") {
            if (!onlyDiff) {
                renderLine(leftView, lnum++, cur.line, "equal");
                renderLine(rightView, rnum++, cur.line, "equal");
            } else {
                lnum++; rnum++;
            }
            i++;
        } 
        else {
            let removes = [];
            let adds = [];

            while (i < script.length && script[i].type !== "equal") {
                if (script[i].type === "remove") removes.push(script[i].line);
                else adds.push(script[i].line);
                i++;
            }

            const maxRows = Math.max(removes.length, adds.length);

            for (let j = 0; j < maxRows; j++) {
                const leftLine = removes[j];
                const rightLine = adds[j];

                if (leftLine !== undefined && rightLine !== undefined) {
                    renderLine(leftView, lnum++, leftLine, "modified", rightLine, false);
                    renderLine(rightView, rnum++, rightLine, "modified", leftLine, true);
                } else if (leftLine !== undefined) {
                    renderLine(leftView, lnum++, leftLine, "removed");
                    renderEmpty(rightView);
                } else if (rightLine !== undefined) {
                    renderEmpty(leftView);
                    renderLine(rightView, rnum++, rightLine, "added");
                }
                diffs.push(diffs.length);
            }
        }
    }
    info.textContent = `${diffs.length} changement(s)`;
}

function gotoDiff(i) {
    if (!diffs.length) return;

    document.querySelectorAll(".diff-active").forEach(d => d.classList.remove("diff-active"));

    diffIndex = (i + diffs.length) % diffs.length;


    const allDiffsL = leftView.querySelectorAll("[data-diff]");
    const allDiffsR = rightView.querySelectorAll("[data-diff]");

    const elL = allDiffsL[diffIndex];
    const elR = allDiffsR[diffIndex];

    if (elL || elR) {
        if (elL) elL.classList.add("diff-active");
        if (elR) elR.classList.add("diff-active");

        const target = elL || elR;
        target.scrollIntoView({ block: "center", behavior: "smooth" });
    }

    info.textContent = `${diffIndex + 1} / ${diffs.length} changement(s)`;
}

function nextDiff() { gotoDiff(diffIndex + 1); }
function prevDiff() { gotoDiff(diffIndex - 1); }

function resetLeft(){ left.value=""; leftView.innerHTML=""; }
function resetRight(){ right.value=""; rightView.innerHTML=""; }
function resetAll(){ resetLeft(); resetRight(); diffs=[]; diffIndex=-1; info.textContent=""; }

function toggleOnlyDiff(){ onlyDiff=!onlyDiff; compare(); }

</script>

</body>
</html>
